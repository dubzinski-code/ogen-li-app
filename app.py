import streamlit as st
import pandas as pd

# -----------------------------
# הגדרות כלליות
# -----------------------------
st.set_page_config(page_title="עוגן לי", layout="wide")

st.title("עוגן לי")
st.caption("כלי מבוסס נתוני עוגן לתכנון כיתתי ואישי")

uploaded_file = st.file_uploader(
    "העלאת קובץ עוגן (Excel)",
    type=["xlsx", "xls"]
)

tabs = st.tabs([
    "תמונת מצב כיתתית",
    "תוכנית עבודה מרובדת",
    "תוכנית התערבות אישית",
    "המלצות גפ\"ן"
])

# -----------------------------
# טעינת קובץ
# -----------------------------
if uploaded_file is not None:
    if uploaded_file.name.endswith(".xls"):
        df = pd.read_excel(uploaded_file, engine="xlrd")
    else:
        df = pd.read_excel(uploaded_file)

    # בדיקת עמודת תלמידים
    if "תלמידי הכיתה" not in df.columns:
        st.error("העמודה 'תלמידי כיתה' לא נמצאה בקובץ.")
        st.stop()

    # -----------------------------
    # לשונית 1 – תמונת מצב כיתתית
    # -----------------------------
    with tabs[0]:
        st.header("תמונת מצב כיתתית")

        st.info(
            "תצוגה זו מציגה תמונת מצב כיתתית-מערכתית המבוססת על נתוני העוגן. "
            "ההצגה אגרגטיבית לפי תחומים, וכוללת שמות תלמידים רק במוקדי קושי."
        )

        # מיפוי תחומים לעמודות
        difficulty_columns = {
            "שפה": "שליטה במיומנויות השפה (דבורה וכתובה) בהתאם למצופה מבני הגיל",
            "מתמטיקה": "שליטה במתמטיקה בהתאם למצופה מבני הגיל",
            "אנגלית": "שליטה באנגלית בהתאם למצופה מבני הגיל (החל מכיתה ד')",
            "מוטיבציה והרגלי למידה": "מוטיבציה והרגלי למידה בהתאם למצופה מבני הגיל",
            "רגשי": "היבטים רגשיים בהתאם למצופה מבני הגיל",
            "התנהגותי": "היבטים התנהגותיים בהתאם למצופה מבני הגיל",
            "חברתי": "היבטים חברתיים בהתאם למצופה מבני הגיל",
            "קשב": "תפקודי קשב ופעלתנות יתר בהתאם למצופה מבני הגיל",
            "חושי-תנועתי-מרחבי": "תפקוד חושי - תנועתי - מרחבי בהתאם למצופה מבני הגיל"
        }

        st.subheader("מוקדי קושי כיתתיים (מתקשה / מתקשה מאד)")

        graph_data = {}

        for domain, col in difficulty_columns.items():
            if col in df.columns:
                # סינון תלמידים מתקשים
                struggling_df = df[df[col].isin(["מתקשה", "מתקשה מאד"])]

                if not struggling_df.empty:
                    student_names = (
                        struggling_df["תלמידי הכיתה"]
                        .dropna()
                        .unique()
                        .tolist()
                    )

                    # חילוץ הקושי המשותף (טקסט אחרי הדרוג, אם קיים)
                    difficulties = (
                        struggling_df[col]
                        .astype(str)
                        .tolist()
                    )

                    graph_data[domain] = len(student_names)

                    st.markdown(f"### {domain}")
                    st.write(f"**מספר תלמידים:** {len(student_names)}")
                    st.write(
                        "**שמות התלמידים:** " + ", ".join(student_names)
                    )

        if graph_data:
            st.subheader("התפלגות קשיים לפי תחומים")
            graph_df = pd.DataFrame.from_dict(
                graph_data, orient="index", columns=["מספר תלמידים מתקשים"]
            )
            st.bar_chart(graph_df)
        else:
            st.info("לא נמצאו תלמידים מתקשים או מתקשים מאד באף תחום.")

        # חוזקות כיתתיות
        st.subheader("חוזקות ותחומי עניין כיתתיים")

        strengths_col = "התלמיד מגלה עניין ו/או חוזקות בתחום ייחודי אחד או יותר"
        if strengths_col in df.columns:
            strengths_count = (df[strengths_col] == "כן").sum()
            st.metric(
                "מספר תלמידים עם תחומי עניין / חוזקות",
                strengths_count
            )
        else:
            st.info("לא נמצאה עמודת חוזקות בקובץ.")

    # -----------------------------
    # לשונית 2 – תוכנית עבודה מרובדת
    # -----------------------------
    with tabs[1]:
        st.header("תוכנית עבודה מרובדת")
        st.info(
            "לשונית זו תציג מענים כיתתיים לפי MTSS: "
            "אוניברסלי, קבוצתי ואינטנסיבי (שלד בשלב זה)."
        )

    # -----------------------------
    # לשונית 3 – תוכנית התערבות אישית
    # -----------------------------
    with tabs[2]:
        st.header("תוכנית התערבות אישית")

        student = st.selectbox(
            "בחרי תלמיד",
            sorted(df["תלמידי הכיתה"].dropna().unique())
        )

        st.subheader(f"תוכנית אישית עבור: {student}")
        st.info("פירוט אישי יורחב בשלב הבא.")

    # -----------------------------
    # לשונית 4 – המלצות גפ\"ן
    # -----------------------------
    with tabs[3]:
        st.header("המלצות גפ\"ן")
        st.info(
            "כיוונים פדגוגיים כלליים למענה כיתתי או קבוצתי "
            "(ללא ציון שמות תוכניות, ספקים או מוצרים)."
        )

else:
    st.warning("יש להעלות קובץ עוגן (Excel) כדי להתחיל.")
